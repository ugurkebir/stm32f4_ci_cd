image: ubuntu:22.04

pipelines:
  default:
    - step:
        name: Build STM32F4
        runs-on:
          - self.hosted
          - linux.arm64
        script:
          - apt-get update
          - DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
              build-essential cmake make ninja-build python3 python3-pip \
              gcc-arm-none-eabi binutils-arm-none-eabi gdb-multiarch \
              git ca-certificates
          # Eğer CubeMX Makefile varsa:
          - make -j"$(nproc)"
          # CMake kullanıyorsan:
          # - cmake -S . -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=cmake/arm-gcc-toolchain.cmake
          # - cmake --build build -j"$(nproc)"
          - |
            if ls build/*.elf >/dev/null 2>&1; then
              arm-none-eabi-objcopy -O ihex build/*.elf build/firmware.hex || true
              arm-none-eabi-objcopy -O binary build/*.elf build/firmware.bin || true
            fi
        artifacts:
          - build/**/*.elf
          - build/**/*.hex
          - build/**/*.bin

    - step:
        name: Unit tests host
        runs-on:
          - self.hosted
          - linux.arm64
        script:
          - echo "No unit tests yet"
          # Ceedling/Unity veya GTest eklediğinde gerçek komutları buraya koy
          # örn: ceedling test:all  veya  ctest --output-on-failure
