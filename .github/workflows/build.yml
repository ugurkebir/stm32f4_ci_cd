# .github/workflows/build.yml

name: STM32F4 CI/CD Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-firmware:
    name: Build STM32F4 Firmware
    
    # Runner'ı etiketlediğimiz gibi çağırıyoruz. Bu doğru.
    # macOS runner'ımız bu etiketlere sahip olduğu için işi alacak.
    runs-on: [self-hosted, linux, arm64]

    steps:
      # Adım 1: Kodu checkout et
      # Bu adım doğrudan macOS runner üzerinde çalışır.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Adım 2: Derlemeyi yap
      # Bu adımı manuel olarak Docker içinde çalıştıracağız.
      - name: Build firmware
        run: |
          # macOS runner'ımıza, Docker'ı kullanarak bir komut çalıştırmasını söylüyoruz:
          # --rm = Konteyner işi bitince kendini silsin.
          # -v "${{ github.workspace }}:/app" = Checkout edilen kodu (macOS'taki)
          #     konteyner içindeki /app klasörüne bağla (mount et).
          # -w /app = Konteynerin çalışma dizinini /app(base_app olarak ayarla.
          # ugurkebir/stm32f4-build:14.3-rel1 = Kullanılacak imaj.
          # make -j"$(nproc)" = İmaj içinde çalıştırılacak komut.
          docker run --rm -v "${{ github.workspace }}:/app" -w /app/base_app \
          docker.io/ugurkebir/stm32f4-build:14.3-rel1 \
          make -j"$(nproc)"

      # Adım 3: .hex ve .bin dosyalarını oluştur
      # Bu adımı da aynı yöntemle Docker içinde çalıştırıyoruz.
      - name: Create HEX and BIN files
        run: |
          docker run --rm -v "${{ github.workspace }}:/app" -w /app/base_app \
          docker.io/ugurkebir/stm32f4-build:14.3-rel1 \
          sh -c "if ls build/*.elf >/dev/null 2>&1; then \
                    arm-none-eabi-objcopy -O ihex build/*.elf build/firmware.hex; \
                    arm-none-eabi-objcopy -O binary build/*.elf build/firmware.bin; \
                 else \
                    echo 'Hata: Derleme sonrası .elf dosyası bulunamadı.'; \
                    exit 1; \
                 fi"

      # Adım 4: Artifact'leri yükle
      # Bu adım tekrar macOS runner üzerinde çalışır ve macOS üzerindeki
      # 'build' klasöründen dosyaları alır (çünkü Docker oraya yazdı).
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stm32-firmware
          path: |
            build/*.elf
            build/*.hex
            build/*.bin

  # Unit test işini de aynı mantıkla güncelliyoruz
  unit-tests:
    name: Unit Tests
    needs: build-firmware 
    runs-on: [self-hosted, linux, arm64]
    
    # 'container:' bloğunu buradan da kaldırıyoruz.
    
    steps:
      - name: Run unit tests
        # İhtiyaç duyulursa, burayı da 'docker run ...' komutuyla
        # konteyner içinde çalıştırabilirsiniz.
        run: echo "No unit tests yet (running on host)"
