# .github/workflows/build.yml

name: STM32F4 CI/CD Build

# Bu workflow'u ne zaman çalıştıracağımızı belirliyoruz:
# 'main' branch'ine push yapıldığında VEYA 'main' branch'ine yönelik bir pull request açıldığında.
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 'build' adında bir iş (job) tanımlıyoruz
  build-firmware:
    name: Build STM32F4 Firmware
    
    # Bu işin hangi koşucuda (runner) çalışacağını belirtiyoruz.
    # Etiketlerinizin (self.hosted, linux.arm64) GitHub Actions'taki karşılığı
    # [self-hosted, linux, arm64] şeklindedir.
    # Bu, M4 makinenizdeki runner'ı hedefleyecektir.
    runs-on: [self-hosted, linux, arm64]

    # Bu işin adımlarını bir konteyner içinde çalıştırıyoruz.
    # Bu, sizin Docker Hub'daki özel imajınızdır.
    container:
      image: docker.io/ugurkebir/stm32f4-build:14.3-rel1

    steps:
      # Adım 1: Kodu checkout et (GitHub reposundaki kodları runner'a indir)
      # Bu adım olmadan 'make' komutu çalışmaz.
      - name: Checkout repository
        uses: actions/checkout@v4

      # Adım 2: Derlemeyi yap
      # 'script' bloğunuzdaki komutları buraya taşıyoruz.
      # NOT: 'apt-get update' komutu muhtemelen gereksizdir, çünkü 
      # tüm bağımlılıklar (make, arm-none-eabi-gcc vb.) zaten 
      # 'ugurkebir/stm32f4-build' imajınızın içinde olmalıdır.
      # Eğer imajınızda yoksa, bu komutu 'sudo apt-get update' olarak ekleyebilirsiniz.
      - name: Build firmware
        run: |
          # '|| true' kısmını kaldırdım. Derleme başarısız olursa
          # pipeline'ın da başarısız olması (kırmızı yanması) gerekir.
          make -j"$(nproc)"

      # Adım 3: .hex ve .bin dosyalarını oluştur
      - name: Create HEX and BIN files
        run: |
          if ls build/*.elf >/dev/null 2>&1; then
            arm-none-eabi-objcopy -O ihex build/*.elf build/firmware.hex
            arm-none-eabi-objcopy -O binary build/*.elf build/firmware.bin
          else
            echo "Hata: Derleme sonrası .elf dosyası bulunamadı."
            exit 1
          fi

      # Adım 4: Derlenen dosyaları 'artifact' olarak kaydet
      # Bu dosyalar, workflow bittikten sonra GitHub arayüzünden indirilebilir.
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stm32-firmware
          path: |
            build/*.elf
            build/*.hex
            build/*.bin

  # İkinci 'step'inizi ayrı bir 'job' olarak ekledim.
  # Bu, 'build-firmware' işi bittikten sonra çalışacaktır.
  unit-tests:
    name: Unit Tests
    # 'build-firmware' işinin başarılı olmasını bekler
    needs: build-firmware 
    runs-on: [self-hosted, linux, arm64]
    container:
      image: docker.io/ugurkebir/stm32f4-build:14.3-rel1

    steps:
      - name: Run unit tests
        run: echo "No unit tests yet"